<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>GradePay 95 ‚Äî –°–∫–æ–±–∫–∏-–Ω–∞–≤–∏–≥–∞—Ü–∏—è: –ü—Ä–æ—Ñ–∏–ª–∏ ‚Ä¢ –î–Ω–µ–≤–Ω–∏–∫ ‚Ä¢ –í–≤–æ–¥ ‚Ä¢ –ò—Ç–æ–≥–∏ ‚Ä¢ –ì–∞–π–¥</title>
<meta name="theme-color" content="#0b5aa7"/>

<!-- üîπ –§–ê–í–ò–ö–û–ù: –∫–∞—Ä—Ç–∏–Ω–∫–∞ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ -->
<link rel="icon" type="image/png" sizes="32x32" href="https://i.ibb.co/chQzx6c1/images.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://i.ibb.co/chQzx6c1/images.png">
<link rel="shortcut icon" href="https://i.ibb.co/chQzx6c1/images.png">
<link rel="apple-touch-icon" href="https://i.ibb.co/chQzx6c1/images.png">

<style>
/* ============================= THEME: Win95 —á–∏—Å—Ç—ã–π ============================= */
:root{
  --desk:#1c222a; --face:#e6e6e6; --ink:#0e0e0e; --edge:#9a9a9a;
  --t1:#0b5aa7; --t2:#073f7d; --ok:#0a7d2a; --bad:#a31c1c; --warn:#b27d00; --accent:#0a77d5;
  --muted:#6b6b6b; --hl:#ffd400; --face2:#f5f5f5;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:"MS Sans Serif",Tahoma,Arial,sans-serif;color:#111;background:linear-gradient(180deg,#161b21,#1c222a)}
.app{max-width:1200px;margin:0 auto;padding:14px}
.win{background:var(--face);border:2px solid var(--ink);
  box-shadow:inset -1px -1px 0 var(--ink),inset 1px 1px 0 #fff,inset -2px -2px 0 var(--edge),inset 2px 2px 0 var(--face)}
.title{position:sticky;top:0;z-index:20;display:flex;align-items:center;gap:8px;color:#fff;
  padding:6px 8px;font-weight:bold;background:linear-gradient(var(--t1),var(--t2))}
.title .r{margin-left:auto;display:flex;gap:6px;flex-wrap:wrap}
.btn{display:inline-block;padding:6px 10px;background:var(--face);cursor:pointer;user-select:none;
  box-shadow:inset -1px -1px 0 var(--ink),inset 1px 1px 0 #fff,inset -2px -2px 0 var(--edge),inset 2px 2px 0 var(--face)}
.btn:active{box-shadow:inset 1px 1px 0 var(--ink),inset -1px -1px 0 #fff,inset 2px 2px 0 var(--edge),inset -2px -2px 0 var(--face);transform:translateY(1px)}
input[type="text"],input[type="number"],input[type="week"],select{
  background:#fff;border:none;padding:6px 7px;min-width:110px;
  box-shadow:inset -1px -1px 0 var(--ink),inset 1px 1px 0 #fff,inset -2px -2px 0 var(--edge),inset 2px 2px 0 var(--face)}
.badge{padding:2px 6px;background:#f7f7f7;border:1px solid #9a9a9a}
.row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
h3{margin:0 0 10px;font-weight:normal}
.sep{height:1px;background:#cfcfcf;margin:10px 0}

/* ============================= LAYOUT: –õ–µ–≤–æ–µ –º–µ–Ω—é ¬´—Å–∫–æ–±–∫–∏¬ª ============================= */
.layout{display:grid;grid-template-columns:230px 1fr;gap:10px;min-height:70vh}
.nav{background:var(--face);padding:10px;border-right:2px solid var(--ink);
  box-shadow:inset -1px 0 0 var(--ink),inset 1px 0 0 #fff; position:relative}

/* üîπ –ö–Ω–æ–ø–∫–∞ ¬´—Ç—Ä–∏ —Ç–æ—á–∫–∏¬ª –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –º–µ–Ω—é */
.nav .navToggle{
  position:absolute; top:8px; right:8px; width:28px; height:28px; line-height:26px;
  background:#fff; border:1px solid #9a9a9a; cursor:pointer; text-align:center; user-select:none;
}
.nav .navToggle:active{transform:translateY(1px)}

.nav .brand{margin-bottom:8px;font-size:13px;color:#fff;background:linear-gradient(var(--t1),var(--t2));padding:6px 8px}
.nav .br{display:block;width:100%;text-align:left;margin:4px 0;padding:8px 10px;cursor:pointer;background:#fff;border:1px solid #9a9a9a}
.nav .br::before{content:"‚ü¶ ";color:#000}
.nav .br::after{content:" ‚üß";color:#000}
.nav .br.active{background:#eaf3ff;border-color:var(--accent);outline:1px dotted var(--ink)}
.content{padding:10px}
.page{display:none}
.page.active{display:block}

/* üîπ –°–≤–µ—Ä–Ω—É—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–Ω—é */
.layout.collapsed{grid-template-columns:56px 1fr}
.layout.collapsed .nav .brand,
.layout.collapsed .nav .br{display:none}
.layout.collapsed .nav{padding-right:10px} /* –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫—É ‚ãÆ */

/* ============================= PROFILES ============================= */
.pills{display:flex;gap:8px;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:#fff;border:1px solid #888;cursor:pointer}
.pill.active{background:#eaf3ff;border-color:var(--accent)}
.avatar{width:18px;height:18px;display:inline-grid;place-items:center;background:#cfe7ff;border:1px solid #6ea8e7;font-weight:bold}

/* ============================= JOURNAL ============================= */
.log{max-height:380px;overflow:auto;background:#fff;margin:0;padding:0;list-style:none;
  box-shadow:inset -1px -1px 0 var(--ink),inset 1px 1px 0 #fff,inset -2px -2px 0 var(--edge),inset 2px 2px 0 var(--face)}
.log li{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center;padding:7px 8px;border-bottom:1px dashed #c9c9c9}
.log .del{cursor:pointer}
.money.plus{color:var(--ok);font-weight:bold}
.money.minus{color:var(--bad);font-weight:bold}

/* ============================= CHART ============================= */
canvas{width:100%;height:180px;display:block;background:
  repeating-linear-gradient(0deg,#f7f7f7,#f7f7f7 31px,#efefef 31px,#efefef 32px);border:1px solid #8a8a8a}

/* ============================= TABS (–≤–Ω—É—Ç—Ä–∏ ¬´–í–≤–æ–¥¬ª) ============================= */
.tabs{display:flex;gap:6px;margin-bottom:8px}
.tab{padding:6px 10px;background:var(--face);cursor:pointer}
.tab.active{background:#fff;outline:1px dotted var(--ink)}
.panel{display:none}
.panel.active{display:block}

/* ============================= FOOTER KPI ============================= */
.footer{position:sticky;bottom:0;z-index:10;background:var(--face);padding:6px 8px;border-top:2px solid var(--ink);
  box-shadow:inset -1px 1px 0 #fff,inset 1px -1px 0 #fff}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpi .card{background:#fff;padding:6px 10px;border:1px solid #9a9a9a}
.progress{height:12px;background:#d9d9d9;box-shadow:inset 1px 1px 0 #fff,inset -1px -1px 0 #9a9a9a}
.progress>span{display:block;height:100%;width:0;background:repeating-linear-gradient(45deg,#0a77d5,#0a77d5 10px,#0b9bd8 10px,#0b9bd8 20px);transition:width .35s}
</style>
</head>
<body>
<div class="app">
  <div class="win">
    <div class="title">
      MyChool ‚Äî —Å–æ–∑–¥–∞–Ω–æ –ê–Ω–¥—Ä–µ–µ–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
      <div class="r">
        <button class="btn" id="btnExportCsv">CSV</button>
        <button class="btn" id="btnExportJson">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <label class="btn" style="position:relative;overflow:hidden">
          –ò–º–ø–æ—Ä—Ç JSON
          <input id="importJson" type="file" accept="application/json" style="position:absolute;inset:0;opacity:0;cursor:pointer"/>
        </label>
        <button class="btn" id="btnResetWeek">–°–±—Ä–æ—Å –Ω–µ–¥–µ–ª–∏</button>
      </div>
    </div>

    <div class="layout" id="layout">
      <!-- NAV -->
      <aside class="nav" id="leftNav">
        <button class="navToggle" id="navToggle" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –º–µ–Ω—é">‚ãÆ</button>
        <div class="brand">–†–∞–∑–¥–µ–ª—ã</div>
        <button class="br" data-go="profiles">–ü—Ä–æ—Ñ–∏–ª–∏</button>
        <button class="br" data-go="diary">–î–Ω–µ–≤–Ω–∏–∫</button>
        <button class="br" data-go="input">–í–≤–æ–¥</button>
        <button class="br" data-go="summary">–ò—Ç–æ–≥–∏</button>
        <button class="br" data-go="guide">–ì–∞–π–¥</button>
      </aside>

      <!-- CONTENT -->
      <main class="content">
        <!-- –ü—Ä–æ—Ñ–∏–ª–∏ -->
        <section id="page-profiles" class="page">
          <h3>–ü—Ä–æ—Ñ–∏–ª–∏</h3>
          <div class="row">
            <div id="profiles" class="pills"></div>
          </div>
          <div class="row" style="margin-top:8px">
            <input type="text" id="newProfileName" placeholder="–ò–º—è —Ä–µ–±—ë–Ω–∫–∞"/>
            <button class="btn" id="addProfile">+ –ü—Ä–æ—Ñ–∏–ª—å</button>
          </div>
          <div class="sep"></div>
          <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
          <div id="profilesManage"></div>
          <div class="badge" style="margin-top:8px">–ö–∞–∂–¥—ã–π –ø—Ä–æ—Ñ–∏–ª—å —Ö—Ä–∞–Ω–∏—Ç —Å–≤–æ–∏ –Ω–µ–¥–µ–ª–∏, –ø—Ä–∞–≤–∏–ª–∞ –∏ –∂—É—Ä–Ω–∞–ª. –ü–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º ‚Äî —Å–¥–µ–ª–∞–π—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç JSON.</div>
        </section>

        <!-- –î–Ω–µ–≤–Ω–∏–∫ -->
        <section id="page-diary" class="page">
          <h3>–î–Ω–µ–≤–Ω–∏–∫ –Ω–µ–¥–µ–ª–∏</h3>
          <div class="row" style="margin-bottom:6px">
            <label>–ù–µ–¥–µ–ª—è: <input type="week" id="weekPick"></label>
            <input type="text" id="filterSubject" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É‚Ä¶"/>
            <select id="filterDay">
              <option value="">–î–µ–Ω—å‚Ä¶</option><option>–ü–Ω</option><option>–í—Ç</option><option>–°—Ä</option><option>–ß—Ç</option><option>–ü—Ç</option><option>–°–±</option>
            </select>
            <button class="btn" id="clearFilters">–°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤</button>
            <span class="badge">–£–¥–∞–ª—è–π—Ç–µ —Å—Ç—Ä–æ–∫–∏ (üóë) –∏–ª–∏ ¬´–û—Ç–º–µ–Ω–∏—Ç—å¬ª ‚Äî —Å–Ω–∏–º–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–∏—Å—å</span>
            <span class="row" style="margin-left:auto">
              <button class="btn" id="undo">–û—Ç–º–µ–Ω–∏—Ç—å</button>
              <button class="btn" id="clearLog">–û—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª</button>
            </span>
          </div>
          <ul id="log" class="log"></ul>
        </section>

        <!-- –í–≤–æ–¥ -->
        <section id="page-input" class="page">
          <h3>–í–≤–æ–¥ –æ—Ü–µ–Ω–æ–∫</h3>
          <div class="tabs">
            <div class="tab active" data-tab="tap">–ö–Ω–æ–ø–∫–∏</div>
            <div class="tab" data-tab="qty">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
            <div class="tab" data-tab="voice">–î–∏–∫—Ç–æ–≤–∫–∞</div>
          </div>

          <div id="panel-tap" class="panel active">
            <div class="row" style="margin:8px 0">
              <input type="text" id="subject" placeholder="–ü—Ä–µ–¥–º–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞)"/>
              <select id="daySelect">
                <option value="">–î–µ–Ω—å‚Ä¶</option><option>–ü–Ω</option><option>–í—Ç</option><option>–°—Ä</option><option>–ß—Ç</option><option>–ü—Ç</option><option>–°–±</option>
              </select>
              <button class="btn" data-add="5">+ 5</button>
              <button class="btn" data-add="4">+ 4</button>
              <button class="btn" data-add="3">+ 3</button>
              <button class="btn" data-add="2">+ 2</button>
              <span class="badge">–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏: 5 / 4 / 3 / 2</span>
            </div>
          </div>

          <div id="panel-qty" class="panel">
            <div class="row" style="margin:8px 0">
              <label>¬´5¬ª: <input type="number" id="q5" min="0" value="0"></label>
              <label>¬´4¬ª: <input type="number" id="q4" min="0" value="0"></label>
              <label>¬´3¬ª: <input type="number" id="q3" min="0" value="0"></label>
              <label>¬´2¬ª: <input type="number" id="q2" min="0" value="0"></label>
              <button class="btn" id="applyQty">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
              <button class="btn" id="clearQty">–û–±–Ω—É–ª–∏—Ç—å</button>
              <span class="badge" id="qtyPreview">–ü—Ä–µ–¥–ø—Ä–æ—Å—á—ë—Ç: 0 ‚ÇΩ</span>
            </div>
            <div class="badge">¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å¬ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –∂—É—Ä–Ω–∞–ª: –¥–æ–±–∞–≤–∏—Ç/—É–±–µ—Ä—ë—Ç —Å—Ç—Ä–æ–∫–∏, —á—Ç–æ–±—ã —Å–æ–≤–ø–∞–¥–∞–ª–∏ —Å—á—ë—Ç—á–∏–∫–∏.</div>
          </div>

          <div id="panel-voice" class="panel">
            <div class="row" style="margin:8px 0">
              <button class="btn" id="startRec">üéô –°—Ç–∞—Ä—Ç</button>
              <button class="btn" id="stopRec" disabled>–°—Ç–æ–ø</button>
              <span class="badge" id="recState">off</span>
            </div>
            <div class="badge" id="liveText"></div>
            <div class="badge">–ü—Ä–∏–º–µ—Ä—ã: ¬´–ø—è—Ç—å –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ –≤ –ø–Ω¬ª, ¬´—á–µ—Ç—ã—Ä–µ –ø–æ —Ä—É—Å—Å–∫–æ–º—É¬ª, ¬´—Ç—Ä–∏ –≤ —Å—Ä¬ª.</div>
          </div>
        </section>

        <!-- –ò—Ç–æ–≥–∏ -->
        <section id="page-summary" class="page">
          <h3>–ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏</h3>
          <div class="row">
            <label>–ù–µ–¥–µ–ª—è: <input type="week" id="weekPick2"></label>
            <label>5 = <input type="number" id="p5" value="300" step="50"></label>
            <label>4 = <input type="number" id="p4" value="150" step="50"></label>
            <label>3 = <input type="number" id="p3" value="-150" step="50"></label>
            <label>2 = <input type="number" id="p2" value="-300" step="50"></label>
            <label style="margin-left:auto">–¶–µ–ª—å (‚ÇΩ): <input type="number" id="goal" value="1000" step="50"></label>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="badge" id="achievements">–ê—á–∏–≤–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ –º–µ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</div>
          </div>
          <canvas id="chart"></canvas>
        </section>

        <!-- –ì–∞–π–¥ -->
        <section id="page-guide" class="page">
          <h3>–ì–∞–π–¥ –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π</h3>
          <ol>
            <li><b>–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å —Ä–µ–±—ë–Ω–∫–∞.</b> –£ –∫–∞–∂–¥–æ–≥–æ —Å–≤–æ–∏ –ø—Ä–∞–≤–∏–ª–∞ –∏ –∂—É—Ä–Ω–∞–ª.</li>
            <li><b>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–¥–µ–ª—é.</b> –î–∞–Ω–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—å–Ω–æ –ø–æ –Ω–µ–¥–µ–ª—è–º.</li>
            <li><b>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ü–µ–Ω—ã –∏ —Ü–µ–ª—å.</b> 5/4 ‚Äî –ø–ª—é—Å, 3/2 ‚Äî —à—Ç—Ä–∞—Ñ—ã.</li>
            <li><b>–§–∏–∫—Å–∏—Ä—É–π—Ç–µ —Ñ–∞–∫—Ç—ã.</b> –í–≤–æ–¥ –∫–Ω–æ–ø–∫–∞–º–∏, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∏–ª–∏ –¥–∏–∫—Ç–æ–≤–∫–æ–π.</li>
            <li><b>–ï–∂–µ–¥–Ω–µ–≤–Ω–æ 3 –º–∏–Ω—É—Ç—ã.</b> –ß—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å? –ß—Ç–æ —É–ª—É—á—à–∏–º –∑–∞–≤—Ç—Ä–∞?</li>
            <li><b>–ù–∞–≥—Ä–∞–¥—ã.</b> 50% —Ü–µ–ª–∏ ‚Äî –∞–≤–∞–Ω—Å, 100% ‚Äî ¬´–∑–∞—Ä–ø–ª–∞—Ç–∞¬ª/–ø–æ—Ö–æ–¥ –≤ –∫–∏–Ω–æ –∏ —Ç.–ø.</li>
            <li><b>–ê—á–∏–≤–∫–∏.</b> –ë–µ–∑ –¥–≤–æ–µ–∫, —Å–µ—Ä–∏—è ¬´5¬ª, —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ ¬´4¬ª ‚Äî –æ—Ç–º–µ—á–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å.</li>
            <li><b>–ù–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ —Å –¥—Ä—É–≥–∏–º–∏.</b> –¢–æ–ª—å–∫–æ —Å –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ–π —Ä–µ–±—ë–Ω–∫–∞.</li>
            <li><b>–≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç.</b> CSV –¥–ª—è –æ—Ç—á—ë—Ç–∞, JSON ‚Äî –ø–æ–ª–Ω—ã–π –±—ç–∫–∞–ø.</li>
            <li><b>–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ ‚Äî</b> ¬´–°–±—Ä–æ—Å –Ω–µ–¥–µ–ª–∏¬ª –∏ —Å–ø–æ–∫–æ–π–Ω–æ –¥–∞–ª—å—à–µ.</li>
          </ol>
        </section>
      </main>
    </div>

    <!-- FOOTER KPI -->
    <div class="footer">
      <div class="kpi">
        <div class="card">–ü—Ä–æ—Ñ–∏–ª—å: <b id="kProfile">‚Äî</b></div>
        <div class="card">–ù–µ–¥–µ–ª—è: <b id="kWeek">‚Äî</b></div>
        <div class="card">–ò—Ç–æ–≥: <b id="kTotal">0 ‚ÇΩ</b></div>
        <div class="card">–¶–µ–ª—å: <b id="kGoal">‚Äî</b></div>
        <div class="card">–í—ã–ø–æ–ª–Ω–µ–Ω–æ: <b id="kPct">0%</b></div>
        <div class="card">–°—Ç–∞—Ç—É—Å: <b id="kBadge">–°—Ç–∞—Ä—Ç</b></div>
      </div>
      <div class="progress" style="margin-top:6px"><span id="kBar"></span></div>
    </div>
  </div>
</div>

<script>
/* ============================= HELPERS & STATE ============================= */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const money=n=>(n>=0? n.toLocaleString('ru-RU')+' ‚ÇΩ':'‚àí'+Math.abs(n).toLocaleString('ru-RU')+' ‚ÇΩ');
const esc=s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
const uid=()=>Math.random().toString(36).slice(2,9);

const Store=(()=>{
  const st={profileId:null,profileName:'',week:'',prices:{5:300,4:150,3:-150,2:-300},goal:1000,counts:{5:0,4:0,3:0,2:0},log:[]};
  const subs=new Set();
  const get=()=>JSON.parse(JSON.stringify(st));
  const set=x=>{Object.assign(st,x); notify();};
  const setCounts=x=>{st.counts=x; notify();};
  const setLog=x=>{st.log=x; notify();};
  const addEntry=it=>{st.log.unshift(it); st.counts[it.grade]=(st.counts[it.grade]||0)+1; notify();};
  const removeEntry=id=>{const i=st.log.findIndex(x=>x.id===id); if(i>=0){const g=st.log[i].grade; st.log.splice(i,1); st.counts[g]=Math.max(0,(st.counts[g]||0)-1); notify();}};
  const undo=()=>{if(!st.log.length) return; const it=st.log.shift(); st.counts[it.grade]=Math.max(0,(st.counts[it.grade]||0)-1); notify();};
  const clearWeek=()=>{st.counts={5:0,4:0,3:0,2:0}; st.log=[]; notify();};
  const subscribe=fn=>subs.add(fn), unsubscribe=fn=>subs.delete(fn), notify=()=>subs.forEach(fn=>fn(get()));
  return {get,set,setCounts,setLog,addEntry,removeEntry,undo,clearWeek,subscribe,unsubscribe};
})();

/* ============================= PROFILES LIST ============================= */
let profiles=[];
function loadProfiles(){ try{profiles=JSON.parse(localStorage.getItem('gp_profiles_v1')||'[]');}catch{profiles=[]}
  if(!profiles.length){ profiles=[{id:uid(),name:'–†–µ–±—ë–Ω–æ–∫'}]; saveProfiles(); }
  drawProfiles(); selectProfile(profiles[0].id);
}
function saveProfiles(){ localStorage.setItem('gp_profiles_v1', JSON.stringify(profiles)); }
function drawProfiles(){
  const box=$('#profiles'); box.innerHTML='';
  profiles.forEach(p=>{
    const el=document.createElement('div'); el.className='pill'; el.dataset.id=p.id;
    el.innerHTML=`<span class="avatar">${(p.name||'?')[0]?.toUpperCase()||'?'}</span><span>${p.name||'–ë–µ–∑ –∏–º–µ–Ω–∏'}</span>`;
    el.onclick=()=>selectProfile(p.id);
    box.appendChild(el);
  });
  drawProfilesManage();
}
function drawProfilesManage(){
  const box=$('#profilesManage'); box.innerHTML='';
  profiles.forEach(p=>{
    const row=document.createElement('div'); row.className='row';
    const inp=document.createElement('input'); inp.value=p.name; inp.style.minWidth='180px';
    const use=document.createElement('button'); use.className='btn'; use.textContent='–°–¥–µ–ª–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–º';
    const del=document.createElement('button'); del.className='btn'; del.textContent='–£–¥–∞–ª–∏—Ç—å';
    inp.oninput=()=>{p.name=inp.value; saveProfiles(); drawProfiles(); if(Store.get().profileId===p.id) Store.set({profileName:p.name});};
    use.onclick=()=>selectProfile(p.id);
    del.onclick=()=>{
      if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏ –≤—Å–µ –µ–≥–æ –Ω–µ–¥–µ–ª–∏?')) return;
      // wipe weeks
      Object.keys(localStorage).forEach(k=>{ if(k.startsWith('gp_data_'+p.id+'_')) localStorage.removeItem(k); });
      profiles=profiles.filter(x=>x.id!==p.id); if(!profiles.length){profiles=[{id:uid(),name:'–†–µ–±—ë–Ω–æ–∫'}];}
      saveProfiles(); drawProfiles(); selectProfile(profiles[0].id);
    };
    row.appendChild(inp); row.appendChild(use); row.appendChild(del);
    box.appendChild(row);
  });
}
$('#addProfile').onclick=()=>{
  const name=($('#newProfileName').value||'').trim()||'–ë–µ–∑ –∏–º–µ–Ω–∏';
  const p={id:uid(),name}; profiles.push(p); saveProfiles(); drawProfiles(); selectProfile(p.id); $('#newProfileName').value='';
};

function ensureISOWeek(){
  const now=new Date();
  const t=new Date(Date.UTC(now.getFullYear(),now.getMonth(),now.getDate()));
  const dow=t.getUTCDay()||7; t.setUTCDate(t.getUTCDate()+4-dow);
  const s=new Date(Date.UTC(t.getUTCFullYear(),0,1));
  const w=String(Math.ceil((((t-s)/86400000)+1)/7)).padStart(2,'0');
  const val=now.getUTCFullYear()+'-W'+w;
  $('#weekPick').value=val; $('#weekPick2').value=val;
  return val;
}
function key(){ const s=Store.get(); return 'gp_data_'+s.profileId+'_'+(s.week||ensureISOWeek()); }
function saveWeek(){ const s=Store.get(); localStorage.setItem(key(), JSON.stringify({prices:s.prices,goal:s.goal,counts:s.counts,log:s.log})); renderKPI(); }
function loadWeek(){
  const raw=localStorage.getItem(key());
  if(!raw){
    Store.set({prices:{5:300,4:150,3:-150,2:-300},goal:1000}); Store.setCounts({5:0,4:0,3:0,2:0}); Store.setLog([]);
  }else{
    try{ const d=JSON.parse(raw);
      Store.set({prices:d.prices||{5:300,4:150,3:-150,2:-300},goal:d.goal||1000});
      Store.setCounts(d.counts||{5:0,4:0,3:0,2:0}); Store.setLog(d.log||[]);
    }catch{ Store.set({prices:{5:300,4:150,3:-150,2:-300},goal:1000}); Store.setCounts({5:0,4:0,3:0,2:0}); Store.setLog([]); }
  }
  renderAll(Store.get());
}

function selectProfile(id){
  const p=profiles.find(x=>x.id===id); if(!p) return;
  const week=ensureISOWeek();
  Store.set({profileId:id,profileName:p.name,week});
  $$('#profiles .pill').forEach(n=>n.classList.toggle('active', n.dataset.id===id));
  loadWeek(); renderKPI();
}

/* ============================= NAV (—Å–∫–æ–±–∫–∏) ============================= */
const routes=['profiles','diary','input','summary','guide'];
function go(to){ routes.forEach(r=>{ $('#page-'+r).classList.toggle('active', r===to); }); $$('.nav .br').forEach(b=>b.classList.toggle('active', b.dataset.go===to)); location.hash=to; }
window.addEventListener('hashchange',()=>{ const h=location.hash.replace('#',''); if(routes.includes(h)) go(h); });
$$('.nav .br').forEach(b=>b.addEventListener('click',()=>go(b.dataset.go)));
go(location.hash.replace('#','')||'diary');

/* üîπ –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–≤—ë—Ä–Ω—É—Ç–æ–≥–æ –º–µ–Ω—é (—Ç—Ä–∏ —Ç–æ—á–∫–∏) */
const layout = document.getElementById('layout');
const navToggle = document.getElementById('navToggle');
if (localStorage.getItem('gp_nav_collapsed')==='1') layout.classList.add('collapsed');
navToggle.addEventListener('click', ()=>{
  layout.classList.toggle('collapsed');
  localStorage.setItem('gp_nav_collapsed', layout.classList.contains('collapsed') ? '1' : '0');
});

/* ============================= RENDER ============================= */
Store.subscribe(renderAll);
function renderAll(s){
  // summary inputs reflect store
  $('#p5').value=s.prices[5]; $('#p4').value=s.prices[4]; $('#p3').value=s.prices[3]; $('#p2').value=s.prices[2]; $('#goal').value=s.goal;
  // qty mirrors counts
  $('#q5').value=s.counts[5]; $('#q4').value=s.counts[4]; $('#q3').value=s.counts[3]; $('#q2').value=s.counts[2];
  // footer
  $('#kProfile').textContent=s.profileName||'‚Äî'; $('#kWeek').textContent=s.week||'‚Äî';
  renderKPI(); renderAchievements(s); drawLog(s); drawChart(s.counts);
  updateQtyPreview();
}
function renderKPI(){
  const s=Store.get();
  const total=s.counts[5]*s.prices[5]+s.counts[4]*s.prices[4]+s.counts[3]*s.prices[3]+s.counts[2]*s.prices[2];
  $('#kTotal').textContent=money(total);
  $('#kGoal').textContent=s.goal?money(s.goal):'‚Äî';
  const pct=s.goal?Math.max(0,Math.min(100,Math.round(total/s.goal*100))):0;
  $('#kPct').textContent=s.goal?(pct+'%'):'‚Äî'; $('#kBar').style.width=(s.goal?pct:0)+'%';
  $('#kBadge').textContent=s.goal&&total>=s.goal?'–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞ üéâ': total>0?'–í –¥–≤–∏–∂–µ–Ω–∏–∏ ‚Üó': (total<0?'–ù—É–∂–Ω–æ –ø–æ–¥—Ç—è–Ω—É—Ç—å—Å—è':'–°—Ç–∞—Ä—Ç');
}
function renderAchievements(s){
  const a=[];
  if(s.counts[2]===0 && (s.counts[5]+s.counts[4]+s.counts[3])>0) a.push('–ë–µ–∑ –¥–≤–æ–µ–∫ ü•á');
  if(s.counts[5]>=3) a.push('–¢—Ä–∏ –ø—è—Ç—ë—Ä–∫–∏ ü•à');
  if(s.counts[4]>=5) a.push('–°—Ç–∞–±–∏–ª—å–Ω–æ ¬´4¬ª ü•â');
  if((s.counts[5]+s.counts[4])>=8) a.push('–°–∏–ª—å–Ω–∞—è –Ω–µ–¥–µ–ª—è üí™');
  $('#achievements').textContent=a.length?a.join(' ‚Ä¢ '):'–ê—á–∏–≤–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ –º–µ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞';
}

/* ============================= JOURNAL DRAW + FILTERS ============================= */
function drawLog(s){
  const ul=$('#log'); if(!ul) return; ul.innerHTML='';
  const fs=($('#filterSubject').value||'').trim().toLowerCase();
  const fd=$('#filterDay').value||'';
  s.log.forEach(it=>{
    const subj=(it.subj||'').toLowerCase();
    if(fs && !subj.includes(fs)) return;
    if(fd && (it.day||'')!==fd) return;
    const li=document.createElement('li'); li.dataset.id=it.id;
    li.innerHTML=`<span class="t"><span class="g">${it.grade}</span> ‚Äî ${esc(it.subj)||'–±–µ–∑ –ø—Ä–µ–¥–º–µ—Ç–∞'} ${it.day? '('+it.day+')':''}</span>
                  <span class="badge src">${it.src||'–≤–≤–æ–¥'}</span>
                  <span class="money ${it.amount>=0?'plus':'minus'}">${money(it.amount)}</span>
                  <span class="del" title="–£–¥–∞–ª–∏—Ç—å">üóë</span>`;
    li.querySelector('.del').onclick=()=>{Store.removeEntry(it.id); saveWeek();};
    ul.appendChild(li);
  });
}
$('#filterSubject')?.addEventListener('input', ()=>drawLog(Store.get()));
$('#filterDay')?.addEventListener('input', ()=>drawLog(Store.get()));
$('#clearFilters')?.addEventListener('click', ()=>{ $('#filterSubject').value=''; $('#filterDay').value=''; drawLog(Store.get()); });
$('#undo')?.addEventListener('click', ()=>{ Store.undo(); saveWeek(); });
$('#clearLog')?.addEventListener('click', ()=>{
  if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª –Ω–µ–¥–µ–ª–∏? –°—á—ë—Ç—á–∏–∫–∏ —Ç–æ–∂–µ –æ–±–Ω—É–ª—è—Ç—Å—è.')) return;
  Store.clearWeek(); saveWeek();
});

/* ============================= CHART ============================= */
function drawChart(counts){
  const c=$('#chart'); if(!c) return; const ctx=c.getContext('2d');
  const W=c.width=c.clientWidth*2, H=c.height=180*2; ctx.clearRect(0,0,W,H);
  const data=[counts[5],counts[4],counts[3],counts[2]], labels=['5','4','3','2']; const max=Math.max(1,...data);
  const pad=40, col=(W-pad*2)/4, bw=col*0.6;
  data.forEach((v,i)=>{
    const x=pad+i*col+(col-bw)/2, h=(v/max)*(H-pad*1.6), y=H-pad-h;
    ctx.fillStyle=i<2?'#0a7d2a':(i===2?'#b77e00':'#a31c1c'); ctx.fillRect(x,y,bw,h);
    ctx.fillStyle='#000'; ctx.font='28px Tahoma'; ctx.textAlign='center';
    ctx.fillText(labels[i], x+bw/2, H-10); ctx.fillText(v, x+bw/2, y-8);
  });
}

/* ============================= INPUT: –∫–Ω–æ–ø–∫–∏ / qty / hotkeys ============================= */
function addEntry(grade, subj='', day='', src='–≤–≤–æ–¥'){
  const s=Store.get(); const amt=s.prices[grade];
  Store.addEntry({id:Date.now().toString(36)+uid(),grade,subj,day,amount:amt,src}); saveWeek();
  $('#log')?.scrollTo({top:0});
}
$$('[data-add]').forEach(b=>b.addEventListener('click',()=>{
  addEntry(+b.dataset.add, $('#subject').value.trim(), $('#daySelect').value, '–∫–Ω–æ–ø–∫–∞');
  $('#subject').value=''; $('#daySelect').value='';
}));
document.addEventListener('keydown',e=>{
  if(/input|select|textarea/i.test(e.target.tagName)) return;
  if(['5','4','3','2'].includes(e.key)) addEntry(+e.key,'','', '–∫–ª–∞–≤–∏—à–∞');
});

/* –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ */
function qObj(){ return {5:+$('#q5').value||0,4:+$('#q4').value||0,3:+$('#q3').value||0,2:+$('#q2').value||0}; }
function updateQtyPreview(){
  if(!$('#qtyPreview')) return;
  const s=Store.get(), q=qObj();
  const t=q[5]*s.prices[5]+q[4]*s.prices[4]+q[3]*s.prices[3]+q[2]*s.prices[2];
  $('#qtyPreview').textContent='–ü—Ä–µ–¥–ø—Ä–æ—Å—á—ë—Ç: '+money(t);
}
['#q5','#q4','#q3','#q2'].forEach(sel=>$(sel)?.addEventListener('input', updateQtyPreview));
$('#clearQty')?.addEventListener('click',()=>{['#q5','#q4','#q3','#q2'].forEach(sel=>$(sel).value=0); updateQtyPreview();});
$('#applyQty')?.addEventListener('click',()=>{ syncLogToCounts(qObj()); });

function syncLogToCounts(target){
  const s=Store.get(); const cur={...s.counts};
  const kept={5:0,4:0,3:0,2:0}; const newLog=[];
  for(const it of s.log){ const g=it.grade; if(kept[g]<target[g]){ newLog.push(it); kept[g]++; } }
  const toAdd={5:target[5]-kept[5],4:target[4]-kept[4],3:target[3]-kept[3],2:target[2]-kept[2]};
  const adds=[];
  Object.entries(toAdd).forEach(([g,d])=>{ for(let i=0;i<d;i++) adds.push({id:Date.now().toString(36)+uid(),grade:+g,subj:'',day:'',amount:s.prices[+g],src:'–∫–æ–ª-–≤–æ'}); });
  Store.setLog(adds.concat(newLog)); Store.setCounts(target); saveWeek();
  $('#q5').value=target[5]; $('#q4').value=target[4]; $('#q3').value=target[3]; $('#q2').value=target[2]; updateQtyPreview();
}

/* Tabs inside Input */
$$('.tab').forEach(t=>t.addEventListener('click',()=>{
  $$('.tab').forEach(x=>x.classList.remove('active')); $$('.panel').forEach(x=>x.classList.remove('active'));
  t.classList.add('active'); $('#panel-'+t.dataset.tab).classList.add('active');
}));

/* ============================= PRICES & GOAL ============================= */
['p5','p4','p3','p2'].forEach(id=>{
  $('#'+id)?.addEventListener('input',()=>{ const s=Store.get(); const prices={...s.prices}; prices[+id.slice(1)]=+$('#'+id).value||0; Store.set({prices}); saveWeek(); updateQtyPreview(); });
});
$('#goal')?.addEventListener('input',()=>{ Store.set({goal:+$('#goal').value||0}); saveWeek(); });

/* Weeks (both places) */
function setWeekAll(val){ Store.set({week:val}); $('#weekPick').value=val; $('#weekPick2').value=val; loadWeek(); }
$('#weekPick')?.addEventListener('input',()=>setWeekAll($('#weekPick').value));
$('#weekPick2')?.addEventListener('input',()=>setWeekAll($('#weekPick2').value));

/* ============================= VOICE ============================= */
const recBadge=$('#recState'), live=$('#liveText'); let recog=null;
function SR(){ return window.SpeechRecognition||window.webkitSpeechRecognition; }
function ensureRec(){ const R=SR(); if(!R){ alert('–î–∏–∫—Ç–æ–≤–∫–∞ —Ç—Ä–µ–±—É–µ—Ç Chrome/Edge/Safari –∏ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.'); return null; } const r=new R(); r.lang='ru-RU'; r.interimResults=true; r.continuous=true; return r; }
function parseSpeech(text){
  const t=text.toLowerCase().replace(/[.,!?]/g,' ').replace(/\s+/g,' ').trim();
  let day=''; if(t.includes('–ø–Ω')) day='–ü–Ω'; else if(t.includes('–≤—Ç')) day='–í—Ç'; else if(t.includes('—Å—Ä')) day='–°—Ä'; else if(t.includes('—á—Ç')) day='–ß—Ç'; else if(t.includes('–ø—Ç')) day='–ü—Ç'; else if(t.includes('—Å–±')) day='–°–±';
  let subj=''; const m=t.match(/–ø–æ ([–∞-—è—ëa-z ]{2,30})/i); if(m) subj=m[1].trim();
  let g=null; if(/\b5\b/.test(t)||t.includes('–ø—è—Ç—å')) g=5; else if(/\b4\b/.test(t)||t.includes('—á–µ—Ç—ã—Ä')) g=4; else if(/\b3\b/.test(t)||t.includes('—Ç—Ä–∏')) g=3; else if(/\b2\b/.test(t)||t.includes('–¥–≤–∞')) g=2;
  if(g!=null) addEntry(g, subj, day, '–≥–æ–ª–æ—Å');
}
$('#startRec')?.addEventListener('click',()=>{
  if(recog) return; recog=ensureRec(); if(!recog) return;
  recBadge.textContent='listening‚Ä¶'; $('#stopRec').disabled=false; let interim='';
  recog.onresult=(e)=>{ let fin=''; for(let i=e.resultIndex;i<e.results.length;i++){const r=e.results[i]; if(r.isFinal) fin+=r[0].transcript+' '; else interim+=r[0].transcript;}
    if(fin){ live.textContent='‚Üí '+fin.trim(); parseSpeech(fin); interim=''; } else live.textContent=interim; };
  recog.onend=()=>{ recBadge.textContent='off'; $('#stopRec').disabled=true; recog=null; };
  recog.start();
});
$('#stopRec')?.addEventListener('click',()=>{ if(recog) recog.stop(); });

/* ============================= EXPORT / IMPORT / RESET ============================= */
$('#btnExportCsv')?.addEventListener('click',()=>{
  const s=Store.get();
  const rows=[['–ü—Ä–æ—Ñ–∏–ª—å',s.profileName],['–ù–µ–¥–µ–ª—è',s.week],
    ['–ü—Ä–∞–π—Å 5',s.prices[5]],['–ü—Ä–∞–π—Å 4',s.prices[4]],['–ü—Ä–∞–π—Å 3',s.prices[3]],['–ü—Ä–∞–π—Å 2',s.prices[2]],
    ['–¶–µ–ª—å',s.goal],[],['–ó–∞–ø–∏—Å—å','–ò—Å—Ç–æ—á–Ω–∏–∫','–°—É–º–º–∞']];
  s.log.slice().reverse().forEach(it=>rows.push([`${it.grade} ‚Äî ${it.subj||''} ${it.day||''}`.trim(), it.src||'', money(it.amount)]));
  const total=s.counts[5]*s.prices[5]+s.counts[4]*s.prices[4]+s.counts[3]*s.prices[3]+s.counts[2]*s.prices[2];
  rows.push([]); rows.push(['–ò–¢–û–ì–û','',money(total)]);
  const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); a.download=`gradepay_${s.profileName||'profile'}_${s.week||'week'}.csv`; a.click();
});
$('#btnExportJson')?.addEventListener('click',()=>{
  const dump={profiles:JSON.parse(JSON.stringify(profiles)),data:{}};
  profiles.forEach(p=>{
    dump.data[p.id]={};
    Object.keys(localStorage).forEach(k=>{
      const pref='gp_data_'+p.id+'_';
      if(k.startsWith(pref)){ dump.data[p.id][k.slice(pref.length)]=JSON.parse(localStorage.getItem(k)); }
    });
  });
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(dump,null,2)],{type:'application/json'})); a.download='gradepay_backup.json'; a.click();
});
$('#importJson')?.addEventListener('change',async(e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{ const obj=JSON.parse(await f.text());
    if(!obj || !Array.isArray(obj.profiles) || typeof obj.data!=='object'){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π JSON'); return; }
    profiles=obj.profiles; saveProfiles(); drawProfiles();
    Object.keys(obj.data||{}).forEach(pid=>{
      const weeks=obj.data[pid]||{}; Object.keys(weeks).forEach(w=>localStorage.setItem('gp_data_'+pid+'_'+w, JSON.stringify(weeks[w])));
    });
    selectProfile(profiles[0]?.id); alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
  }catch(err){ console.error(err); alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞'); }
  e.target.value='';
});
$('#btnResetWeek')?.addEventListener('click',()=>{ if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –Ω–µ–¥–µ–ª—é: –æ–±–Ω—É–ª–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏ –∏ –∂—É—Ä–Ω–∞–ª?')){ Store.clearWeek(); saveWeek(); } });

/* ============================= INIT ============================= */
loadProfiles();
ensureISOWeek();
renderAll(Store.get());
</script>
</body>
</html>
